var http=require('http');
var fs=require('fs');
var url=require('url');
var crypto=require('crypto');

var server=http.createServer(function(req,res){
	var m=req.url.match(/^\/([0-9a-z]{40}\.(jpg|png|gif))$/);
	if(!m){
		res.writeHead(418, {'Content-Type': 'text/plain'});
		return res.end('418 - I\'m a teapot');
	}
	fs.readFile(__dirname+'/sunak'+req.url,function(err,data){
		if(err){
			res.writeHead(404, {'Content-Type': 'text/plain'});
			return res.end('404 - Az akkuntkrokodil megette az adatot!');
		}
		res.writeHead(200,{'Content-Type':'image/'+m[2]});
		res.end(data);
	});
}).listen(80,'2002:5063:b678::5063:b678');

module.exports=function(client){
	client.on('message',function(s,t,m){
		if(m.match(/^sunat\s*/)){
			fs.readdir(__dirname+'/sunak',function(err,files){
				if(err){
					return client.warn('suna',err.toString());
				}
				var choice=files[Math.floor(Math.random()*files.length)];
				client.reply(s,t,'http://[2002:5063:b678::5063:b678]/'+choice);
			})
		}
		if(m=m.match(/^sunaznam (.*?)$/)){
			var suna=m[1];
			var sunaURL=url.parse(suna);
			var hash=crypto.createHash('sha1').update(suna).digest('hex');
			var ext=suna.match(/\.(jpg|png|gif)$/)[1];
			fs.readdir(__dirname+'/sunak',function(err,files){
				if(err){
					return client.warn('suna',err.toString());
				}
				for(var i in files){
					var f=files[i];
					if(f === hash+'.'+ext) return client.reply(s,t,'Sunaduplikatum! :c');
				}
				var req={
					host: sunaURL.hostname,
					port: sunaURL.port||80,
					path: sunaURL.path||'/'
				};
				var start=new Date().getTime();
				http.get(req,function(res){
					client.log('suna', 'Download started: '+suna);
					var pos=0;
					if(parseInt(res.headers['content-length'])>10*1024*1024){
						return client.reply(s,t,'Gooby pls, ez túl nagy falat!');
					}
					var buf=new Buffer(parseInt(res.headers['content-length']));
					res.on('data', function(data){
						data.copy(buf,pos);
						pos+=data.length;
					});
					res.on('end',function(){
						fs.writeFile(__dirname+'/sunak/'+hash+'.'+ext,buf,function(err){
							if(err){
								return client.warn('suna', err.toString());
							}
							var diff=new Date().getTime()-start;
							client.log('suna','Download finished: '+suna+' ('+hash+'.'+ext+')');
							client.reply(s,t,'Suna ACK! ('+Math.floor(pos/1024)+'kB, '+diff+'ms)');
						})
					})
				})
			})
		}
	})
	client.on('command:sunastat',function(s,t){
		fs.readdir(__dirname+'/sunak',function(err,files){
			if(err){
				return client.warn('suna',err.toString());
			}
			client.reply(s,t,files.length+' suna van jelenleg az adatbázisban!');
		})
	})
}