module.exports=function(client){
	client.say=function(target,msg){
		client.write('PRIVMSG '+target+' :'+msg+'\r\n');
	}
	client.reply=function(sender,target,msg){
		if(target.indexOf('#')>-1){
			return client.say(target,sender+': '+msg);
		}
		client.say(sender,msg);
	}
	client.on=function(label,f){
		(listeners[label]&&listeners[label].push(f))||(listeners[label]=[f]);
	}
	var listeners={};
	client.emit=function(label){
		if(!listeners[label]) return;
		var args=Array.prototype.slice.call(arguments,1);
		console.log('Emitting '+label+', args:', args);
		for(var i in listeners[label]){
			listeners[label][i].apply(client,args);
		}
	}
	return function(data,next){
		var m=data.match(/^(:(.*?) )?(.*?) (.*?)\r\n/);
		if(!m){
			return next();
		}
		if(m[3]==='PRIVMSG'){
			var sender=m[2].substr(0,m[2].indexOf('!'));
			m=m[4].match(/(.*?) :(.*)/);
			client.log('message','Message from '+sender+' to '+m[1]+': '+m[2]);
			return client.emit('message',sender,m[1],m[2]);
		}
		if(m[3] === 'PING'){
			client.log('ping','Ping from '+m[4].substr(1));
			return client.emit('ping',m[4].substr(1));
		}
	}
}